# 基于航位推算的在线轨迹简化算法系统设计文档

## 一、系统概述

本系统是一个基于航位推算（Dead Reckoning, DR）的在线轨迹简化算法实现，专门用于处理 AIS（自动识别系统）船舶轨迹数据。系统实现了基于航位推算的在线轨迹压缩算法，并与经典的 Douglas-Peucker（DP）离线算法进行对比分析，提供了完整的评估指标和可视化功能。该系统支持实时流式数据处理，能够通过预测误差控制实现高精度的轨迹压缩，同时提供交互式地图展示压缩效果，并输出压缩率、运行时间等多维度的性能评估指标。

---

## 二、系统模块描述

### 2.1 数据加载与预处理模块

数据加载与预处理模块负责从 CSV 文件读取 AIS 船舶轨迹数据，并对原始数据进行清洗和预处理。该模块的核心函数为`load_data(filepath, mmsi=None)`，其主要功能包括数据读取、数据清洗和数据筛选三个部分。

在数据读取方面，该模块能够读取包含 MMSI（船舶唯一标识）、BaseDateTime（时间戳）、LAT（纬度）、LON（经度）、SOG（对地航速）、COG（对地航向）等关键字段的 CSV 文件。数据清洗过程包括过滤无效的经纬度数据（纬度范围-90 至 90 度，经度范围-180 至 180 度）、移除缺失关键字段的数据行，以及按时间戳进行升序排序，确保轨迹数据的时间连续性。此外，该模块还支持按船舶 MMSI 筛选特定船舶的轨迹数据，便于针对单船轨迹进行分析。模块的输入为 CSV 文件路径和可选的 MMSI 参数，输出为经过清洗和预处理的 pandas DataFrame 对象，为后续算法处理提供高质量的数据基础。

### 2.2 地理计算工具类

地理计算工具类（GeoUtils）提供了地理空间计算所需的核心数学工具，实现了单位转换、距离计算和航位预测等关键功能。该类采用静态方法设计，便于直接调用而无需实例化对象。

在单位转换方面，该类提供了`knots_to_mps(knots)`函数，用于将航速从节（knots）转换为米每秒（m/s），转换系数为 0.514444；同时提供`deg_to_rad(degrees)`函数实现角度到弧度的转换。距离计算功能通过`haversine_distance(lat1, lon1, lat2, lon2)`函数实现，该函数采用 Haversine 公式计算地球表面两点间的大圆距离，考虑了地球曲率的影响，能够提供较高的计算精度，返回值为以米为单位的距离。

航位预测功能是该工具类的核心，通过`predict_position(lat_old, lon_old, speed_mps, course_deg, delta_t)`函数实现。该函数根据起始点的位置、速度、航向以及时间差，预测船舶在指定时间后的新位置。预测过程首先计算行驶距离（速度乘以时间差），然后根据航向角计算经纬度偏移量。在计算经度偏移时，考虑了纬度对经度偏移的影响，使用地球半径（6371000 米）和当前纬度进行修正，确保预测结果的准确性。该函数返回预测的经纬度坐标，为后续的误差计算提供基础。

### 2.3 核心算法实现模块

核心算法实现模块包含两个主要的轨迹压缩算法：基于航位推算的在线压缩算法和 Douglas-Peucker 离线压缩算法。

#### 2.3.1 航位推算压缩算法

航位推算压缩算法（Dead Reckoning Compression）是本系统的核心创新，实现了基于航位推算的在线轨迹压缩功能。该算法通过预测误差判断数据点是否冗余，从而实现轨迹的智能压缩。算法的核心函数为`dead_reckoning_compress(df, threshold_meters=100.0)`，其中阈值参数用于控制压缩的精度。

算法的执行过程分为初始化、遍历处理和结束处理三个阶段。在初始化阶段，算法将轨迹的第一个点作为初始锚点，存入压缩结果列表。在遍历处理阶段，算法从第二个点开始依次遍历轨迹流中的每个数据点。对于当前点，算法首先计算其与上一个锚点之间的时间差，然后使用锚点的速度和航向信息，调用地理计算工具类的预测函数计算当前时刻的预测位置。接着，算法计算实际数据点与预测位置之间的距离误差。判断规则如下：若误差小于预设阈值，说明预测准确，当前点被认为是冗余的，予以丢弃；若误差大于或等于阈值，说明预测失效，当前点包含重要信息，予以保留并更新为新的锚点。在结束处理阶段，算法确保轨迹的最后一个点总是被保留，以维持轨迹的完整性。

该算法具有在线处理的特性，仅需单次遍历即可完成压缩，时间复杂度为 O(n)，其中 n 为轨迹点数，空间复杂度为 O(m)，其中 m 为压缩后的点数。这种设计使得算法能够处理实时数据流，适合实际应用场景的需求。

#### 2.3.2 Douglas-Peucker 压缩算法

Douglas-Peucker 压缩算法（DP Compression）是经典的离线轨迹简化算法，在本系统中主要用于与航位推算算法进行对比分析。该算法的核心函数为`dp_compress(df, epsilon)`，其中 epsilon 参数为垂直距离阈值。该算法采用离线处理方式，需要完整的轨迹数据才能执行，基于垂直距离阈值进行递归简化。本系统使用`rdp`库实现该算法，该库提供了高效的 Ramer-Douglas-Peucker 算法实现，能够快速处理大规模轨迹数据。

### 2.4 评估指标模块

评估指标模块负责计算和展示轨迹压缩算法的性能指标，为算法对比分析提供定量依据。该模块的核心函数为`evaluate_compression(original_df, compressed_df, algorithm_name, elapsed_time)`，能够计算并输出多维度的评估指标。

评估指标包括点数对比、压缩率和运行时间三个方面。点数对比统计原始轨迹的点数（N）和压缩后轨迹的点数（M），直观反映压缩效果。压缩率通过公式 R = (1 - M/N) × 100%计算，表示数据压缩的百分比，压缩率越高说明算法压缩效果越好。运行时间通过 Python 的`time`模块记录算法执行耗时，以秒为单位，用于评估算法的执行效率。该模块在控制台打印详细的评估报告，同时返回包含所有指标的字典对象，便于程序化处理和进一步分析。

### 2.5 可视化展示模块

可视化展示模块使用交互式地图展示原始轨迹和压缩结果，支持多算法结果的对比展示。该模块的核心函数为`visualize_trajectories(original_df, dr_df, dp_df=None, output_file="map.html")`，能够生成包含多个图层的交互式地图。

地图初始化过程使用 folium 库创建交互式地图，地图中心点自动设置为轨迹的起点位置，确保轨迹能够完整显示。轨迹图层包括原始轨迹、DR 压缩轨迹和 DP 压缩轨迹（可选）三个部分。原始轨迹使用红色细线绘制，设置较低的不透明度，作为背景参考；DR 压缩轨迹使用蓝色粗线绘制，设置较高的不透明度，突出显示压缩结果；DP 压缩轨迹使用绿色粗线绘制，用于算法对比。在压缩算法保留的关键点处，系统添加圆点标记，起点和终点使用特殊图标标记，便于识别轨迹的起止位置。

交互功能方面，系统提供图层控制功能，用户可以开关不同轨迹的显示，便于对比分析。鼠标悬停时显示详细信息，支持地图的缩放和拖拽操作，提供良好的用户体验。最终，系统生成 HTML 格式的交互式地图文件，可在浏览器中直接打开查看，无需额外的软件支持。

### 2.6 主执行脚本

主执行脚本作为系统的入口点，负责协调各模块的执行流程，支持真实数据和模拟数据两种模式。脚本的主要流程包括数据加载、算法执行、结果评估和可视化生成四个阶段。

在数据加载阶段，脚本优先尝试从指定路径加载真实的 AIS 数据文件，若加载失败则自动生成模拟轨迹数据。模拟数据包含 50 至 100 个数据点，模拟直线航行和转弯两种典型场景，数据格式与真实 AIS 数据保持一致，包括 MMSI、时间戳、经纬度、航速和航向等字段，可用于算法测试和演示。

在算法执行阶段，脚本依次运行 Dead Reckoning 压缩算法和 Douglas-Peucker 压缩算法。Dead Reckoning 算法使用 100 米作为距离阈值，该阈值可根据实际需求进行调整。Douglas-Peucker 算法使用相应的 epsilon 参数，用于算法对比分析。

在结果评估阶段，脚本调用评估指标模块计算并打印压缩率、运行时间等性能指标，同时输出算法对比总结，包括两种算法的压缩率对比和运行时间对比。在可视化生成阶段，脚本调用可视化模块生成交互式地图 HTML 文件，将原始轨迹和两种算法的压缩结果同时展示在地图上，便于直观对比分析。

---

## 三、编程语言及开发环境

本系统采用 Python 3.10 作为主要编程语言。Python 语言具有丰富的数据处理和科学计算库生态，包括 pandas、numpy、folium 等成熟的开源库，能够快速实现复杂的数据处理、数学计算和可视化功能。Python 的简洁语法和强大的库支持使其成为算法原型实现和快速开发的理想选择。此外，Python 具有良好的跨平台特性，系统可在 Windows、Linux 和 macOS 等主流操作系统上运行，仅需 Python 3.10 或更高版本的环境支持。

---

## 四、开发技术栈

### 4.1 核心依赖库

本系统的开发依赖于多个成熟的开源 Python 库，这些库分别承担数据处理、数值计算、地理空间计算、轨迹压缩算法和数据可视化等功能。

在数据处理方面，系统使用 pandas 库（版本 ≥1.5.0）进行数据加载、清洗和处理。pandas 提供了高效的数据框（DataFrame）操作接口，支持时间序列处理、数据筛选、排序等常用操作，其底层基于 numpy 实现，具有较高的执行效率。numpy 库（版本 ≥1.23.0）则提供基础的数值计算和数组操作功能，支持向量化运算，能够显著提高数学计算的性能。

在地理空间计算方面，系统主要采用自定义实现的地理计算工具类，使用 Haversine 公式和地理坐标近似公式进行计算。geopy 库作为可选依赖，可用于更高级的地理计算需求，但在本系统中未直接使用。

在轨迹压缩算法方面，系统使用 rdp 库（版本 ≥0.8）实现 Douglas-Peucker 算法。该库提供了高效的 Ramer-Douglas-Peucker 算法实现，能够快速处理大规模轨迹数据，支持自定义距离阈值参数。

在数据可视化方面，系统主要使用 folium 库（版本 ≥0.14.0）创建交互式地图。folium 基于 Leaflet.js 构建，提供了丰富的地图交互功能，包括图层控制、缩放、拖拽、标记点等，能够生成高质量的交互式地图 HTML 文件。matplotlib 库（版本 ≥3.6.0）作为可选依赖，可用于静态图表的绘制，但在本系统中主要用于辅助功能。

### 4.2 核心技术

本系统采用多项核心技术实现轨迹压缩和可视化功能。在地理空间计算技术方面，系统使用 Haversine 公式计算地球表面两点间的大圆距离，该公式考虑了地球曲率的影响，能够提供较高的计算精度。航位推算算法基于速度、航向和时间进行位置预测，使用地理坐标近似公式计算经纬度偏移，在计算经度偏移时考虑了纬度的影响，确保预测结果的准确性。

在算法设计技术方面，系统采用在线算法设计理念，实现单次遍历处理，支持流式数据处理。误差控制机制基于距离阈值实现自适应压缩，将预测误差作为判断数据点是否冗余的依据，当预测误差小于阈值时丢弃数据点，否则保留数据点并更新锚点。

在数据处理技术方面，系统实现了完整的数据清洗流程，包括异常值检测和过滤、时间序列排序等操作。系统充分利用 pandas 的矢量化操作提高性能，避免低效的循环处理，确保系统能够高效处理大规模轨迹数据。

### 4.3 软件工程实践

在软件工程实践方面，本系统采用模块化设计理念，将各功能模块独立实现，便于维护和扩展。代码组织遵循函数式编程原则，采用纯函数设计，减少副作用，提高代码的可测试性和可维护性。系统使用 Python 的 typing 模块提供类型提示，提高代码的可读性和 IDE 的智能提示能力。

在错误处理方面，系统实现了完善的数据验证和异常处理机制，对输入数据进行严格验证，对可能出现的异常情况进行友好提示，提高系统的健壮性。在代码文档方面，系统为所有函数提供了详细的文档字符串，使用中文注释说明算法逻辑，便于理解和维护。

---

## 五、系统架构

本系统采用分层模块化架构设计，主执行脚本作为系统入口，协调各功能模块的执行。数据加载模块负责数据的读取和预处理，为算法执行模块提供高质量的数据输入。算法执行模块包含航位推算压缩算法和 Douglas-Peucker 压缩算法两个核心算法，依赖地理工具类提供的地理空间计算功能。结果评估模块对算法执行结果进行定量分析，输出性能指标。可视化模块将原始轨迹和压缩结果以交互式地图的形式展示，提供直观的对比分析界面。各模块之间通过标准的数据接口进行交互，保持低耦合高内聚的设计原则，便于系统的维护和扩展。

---

## 六、技术亮点

本系统具有多项技术亮点。首先，系统实现了真正的在线算法，支持实时流式数据处理，仅需单次遍历即可完成压缩，适合实际应用场景的需求。其次，系统采用基于航位推算的高精度预测算法，考虑了地球曲率的影响，能够准确预测船舶位置，为压缩判断提供可靠依据。第三，系统使用 folium 库生成交互式地图，提供直观的可视化展示，支持多图层对比和交互操作，提升用户体验。第四，系统建立了完整的评估体系，提供压缩率、运行时间等多维度评估指标，支持算法的定量对比分析。第五，系统采用模块化设计，代码结构清晰，各模块功能独立，易于扩展和维护，具有良好的工程实践价值。

---

## 七、系统应用场景

本系统可应用于多个实际场景。在 AIS 数据处理方面，系统可用于船舶轨迹数据的压缩和存储优化，减少数据存储空间，提高数据处理效率。在算法研究方面，系统提供了在线轨迹简化算法的完整实现和评估框架，可用于算法性能评估和对比研究。在教学演示方面，系统提供了直观的可视化界面，便于理解轨迹压缩算法的工作原理和效果。在系统集成方面，本系统可作为独立模块集成到更大的 GIS 系统中，为上层应用提供轨迹压缩服务。

---

## 八、未来扩展方向

本系统具有较大的扩展潜力。在多阈值策略方面，系统可支持动态阈值调整，根据轨迹特征自适应选择最优阈值。在并行处理方面，系统可支持多船舶轨迹的批量处理，利用多核处理器提高处理效率。在算法扩展方面，系统可集成其他轨迹简化算法，如 Top-Down 算法、Bottom-Up 算法等，提供更丰富的算法选择。在性能优化方面，系统可进一步优化算法执行效率，如使用 Cython 加速关键计算，或采用 GPU 加速大规模数据处理。在用户界面方面，系统可开发 Web 界面，提供更友好的交互式操作体验，支持参数调整和实时预览等功能。
